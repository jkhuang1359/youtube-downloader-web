#!/bin/bash
#!/bin/bash

set -e

echo "ğŸš€ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ..."

# è¨­ç½®å·¥ä½œç›®éŒ„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

# åœæ­¢å¯èƒ½ä½”ç”¨ç«¯å£çš„é€²ç¨‹
echo "ğŸ›‘ æ¸…ç†å¯èƒ½ä½”ç”¨çš„ç«¯å£..."
fuser -k 8000/tcp 2>/dev/null || true
fuser -k 8080/tcp 2>/dev/null || true

# æª¢æŸ¥ä¸¦åœæ­¢å·²å­˜åœ¨çš„ Redis å®¹å™¨
echo "ğŸ›‘ æ¸…ç†èˆŠçš„ Redis å®¹å™¨..."
docker stop redis-dev 2>/dev/null || true
docker rm redis-dev 2>/dev/null || true

# å•Ÿå‹• Redisï¼ˆä½¿ç”¨ 6380 ç«¯å£é¿å…è¡çªï¼‰
echo "ğŸ”´ å•Ÿå‹• Redis..."
docker run --name redis-dev -p 6380:6379 -d redis

# ç­‰å¾… Redis å•Ÿå‹•
sleep 2

# å•Ÿå‹•å¾Œç«¯
echo "ğŸŒ å•Ÿå‹•å¾Œç«¯ API..."
cd "$BACKEND_DIR"
source venv/bin/activate

# ç¢ºä¿é…ç½®æ–‡ä»¶å­˜åœ¨ä¸¦ä½¿ç”¨æ­£ç¢ºçš„ Redis ç«¯å£
if [ ! -f "app/config.py" ]; then
    echo "ğŸ“ å‰µå»º config.py..."
    cat > app/config.py << 'EOF'
import os
from dotenv import load_dotenv

load_dotenv()

# ä½¿ç”¨ 6380 ç«¯å£
REDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6380/0")

# å…¶ä»–é…ç½®
DEBUG = True
SECRET_KEY = "dev-secret-key"
EOF
else
    # æ›´æ–°ç¾æœ‰çš„ config.py ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ç«¯å£
    if ! grep -q "6380" app/config.py; then
        echo "ğŸ”„ æ›´æ–° config.py ä½¿ç”¨ Redis 6380 ç«¯å£..."
        sed -i 's/redis:\/\/localhost:6379/redis:\/\/localhost:6380/g' app/config.py 2>/dev/null || true
        sed -i 's/REDIS_URL.*=.*/REDIS_URL = "redis:\/\/localhost:6380\/0"/' app/config.py 2>/dev/null || true
    fi
fi

if [ ! -f "app/celery.py" ]; then
    echo "ğŸ“ å‰µå»º Celery é…ç½®æ–‡ä»¶..."
    cat > app/celery.py << 'EOF'
from celery import Celery
from .config import REDIS_URL

celery_app = Celery(
    "youtube_downloader",
    broker=REDIS_URL,
    backend=REDIS_URL,
    include=["app.tasks"]
)

celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="UTC",
    enable_utc=True,
)
EOF
fi

if [ ! -f "app/tasks.py" ]; then
    echo "ğŸ“ å‰µå»º tasks.py..."
    cat > app/tasks.py << 'EOF'
from .celery import celery_app

@celery_app.task(bind=True)
def test_task(self):
    print("âœ… Celery ä»»å‹™åŸ·è¡ŒæˆåŠŸï¼")
    return {"status": "success", "message": "Celery is working!"}
EOF
fi

# å•Ÿå‹• FastAPI
echo "ğŸš€ å•Ÿå‹• FastAPI..."
# ä½¿ç”¨ 8001 ç«¯å£é¿å…è¡çªï¼Œæˆ–å¼·åˆ¶ä½¿ç”¨ 8000
PORT=8000
if lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null ; then
    echo "âš ï¸  ç«¯å£ 8000 è¢«ä½”ç”¨ï¼Œå˜—è©¦ä½¿ç”¨ 8001"
    PORT=8001
fi

uvicorn app.main:app --reload --host 0.0.0.0 --port $PORT &
BACKEND_PID=$!

# ç­‰å¾…å¾Œç«¯å•Ÿå‹•
sleep 3

# å•Ÿå‹• Celery Worker
echo "âš¡ å•Ÿå‹• Celery Worker..."
celery -A app.celery worker --loglevel=info &
CELERY_PID=$!

# å•Ÿå‹•å‰ç«¯
echo "ğŸ’» å•Ÿå‹•å‰ç«¯æ‡‰ç”¨..."
cd "$FRONTEND_DIR"

# æª¢æŸ¥å‰ç«¯ç«¯å£é…ç½®
if [ -f "vue.config.js" ]; then
    # å¦‚æœå·²æœ‰é…ç½®ï¼Œç¢ºä¿ç«¯å£æ­£ç¢º
    if ! grep -q "8080" vue.config.js; then
        echo "ğŸ”„ æ›´æ–°å‰ç«¯ç«¯å£é…ç½®..."
        cat > vue.config.js << 'EOF'
module.exports = {
  devServer: {
    port: 8080,
    host: '0.0.0.0',
    hot: true,
    historyApiFallback: true,
  }
}
EOF
    fi
else
    echo "ğŸ“ å‰µå»ºå‰ç«¯é…ç½®..."
    cat > vue.config.js << 'EOF'
module.exports = {
  devServer: {
    port: 8080,
    host: '0.0.0.0',
    hot: true,
    historyApiFallback: true,
  }
}
EOF
fi

# ä¿®å¾©å¯èƒ½çš„ ESLint éŒ¯èª¤
if command -v npx &> /dev/null; then
    echo "ğŸ”§ ä¿®å¾©å‰ç«¯æ ¼å¼..."
    npx eslint --fix src/App.vue 2>/dev/null || true
fi

# å¼·åˆ¶ä½¿ç”¨ 8080 ç«¯å£
PORT=8080
if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null ; then
    echo "âš ï¸  å‰ç«¯ç«¯å£ 8080 è¢«ä½”ç”¨ï¼Œå˜—è©¦ä½¿ç”¨ 8081"
    PORT=8081
fi

# è¨­ç½®ç’°å¢ƒè®Šæ•¸è®“ Vue CLI ä½¿ç”¨æŒ‡å®šç«¯å£
export PORT=$PORT
npm run serve -- --port $PORT &
FRONTEND_PID=$!

# ç­‰å¾…æœå‹™å•Ÿå‹•
echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
sleep 5

# ç²å–å¯¦éš›çš„å‰ç«¯ç«¯å£
FRONTEND_PORT=$(lsof -ti:8080,8081,8082 | head -1 | xargs -I {} lsof -p {} | grep LISTEN | grep -E ":(8080|8081|8082)" | head -1 | awk -F: '{print $NF}' | awk '{print $1}')
if [ -z "$FRONTEND_PORT" ]; then
    FRONTEND_PORT="8080"
fi

echo "âœ… æ‰€æœ‰æœå‹™å·²å•Ÿå‹•ï¼"
echo "ğŸ“Š æœå‹™è³‡è¨Šï¼š"
echo "  â€¢ å¾Œç«¯ API: http://localhost:8000"
echo "  â€¢ å‰ç«¯æ‡‰ç”¨: http://localhost:$FRONTEND_PORT"
echo "  â€¢ API æ–‡æª”: http://localhost:8000/docs"
echo "  â€¢ Redis: localhost:6380"
echo "  â€¢ Redis å…§éƒ¨ç«¯å£: 6379"
echo "  â€¢ Celery Worker: é‹è¡Œä¸­"
echo ""
echo "ğŸ›‘ æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœå‹™"

# æ•ç² Ctrl+C ä¿¡è™Ÿ
trap "cleanup" INT

cleanup() {
    echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœå‹™..."
    kill $BACKEND_PID 2>/dev/null || true
    kill $CELERY_PID 2>/dev/null || true
    kill $FRONTEND_PID 2>/dev/null || true
    docker stop redis-dev 2>/dev/null || true
    docker rm redis-dev 2>/dev/null || true
    exit 0
}

# ä¿æŒè…³æœ¬é‹è¡Œ
wait
